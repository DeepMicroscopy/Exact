{% extends 'annotations/base.html' %}
{% load i18n %}
{% load static %}

{% block additional_annotation_js %}
    <script type="text/javascript" src="https://openseadragon.github.io/openseadragon/openseadragon.min.js"></script>
    <script type="text/javascript"
            src="https://rawgit.com/picturae/OpenSeadragonGuides/master/dist/openseadragon-guides.js"></script>
    <script type="text/javascript" src="{% static 'annotations/js/boundingboxes.js' %}"></script>

    <script async  type="text/javascript" src="{% static 'annotations/js/openseadragon-filtering.js' %}"></script>
    <script async  type="text/javascript" src="{% static 'annotations/js/opencv.js' %}"></script>

    <script type="text/javascript" src="{% static 'scripts/notify.min.js' %}"></script>

    <script type="text/javascript" src="{% static 'annotations/js/selection.js' %}"></script>
    <script type="text/javascript" src="{% static 'annotations/js/openseadragon-scalebar.js' %}"></script>


    <script type="text/javascript" src="{% static 'annotations/js/openseadragon-paperjs-overlay.js' %}"></script>
    <script type="text/javascript" src="{% static 'annotations/js/paper-full.js' %}"></script>
    <script type="text/javascript" src="{% static 'annotations/js/imaginghelper.js' %}"></script>
    <script type="text/javascript" src="{% static 'annotations/js/screeningTool.js' %}"></script>
    <script type="text/javascript" src="{% static 'annotations/js/exact-sync.js' %}"></script>
    <script type="text/javascript" src="{% static 'annotations/js/exact-image-viewer.js' %}"></script>
    <script type="text/javascript" src="{% static 'annotations/js/exact-imageset-viewer.js' %}"></script> 
    <script type="text/javascript" src="{% static 'annotations/js/openseadragon_filtering_viewer.js' %}"></script> 
    <script type="text/javascript" src="{% static 'annotations/js/searchTool.js' %}"></script>  
    <script type="text/javascript" src="{% static 'annotations/js/statistics-viewer.js' %}"></script>  
    <script type="text/javascript" src="{% static 'annotations/js/plugin-handler.js' %}"></script>
    <script type="text/javascript" src="{% static 'annotations/js/show-annotation-properties.js' %}"></script>
    <script type="text/javascript" src="{% static 'annotations/js/annotations.js' %}"></script>

    <script type="text/javascript" src="{% static 'annotations/js/bootstrap-slider.min.js' %}"></script>
{% endblock additional_annotation_js %}
{% block bodyblock %}
    <div class="container-fluid">
        <div class="row">


            <div class="col-md-3">
                <div class="row">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <a href="{% url 'images:view_imageset' selected_image.image_set.id %}">
                                <h3 class="panel-title"><u>{{ selected_image.image_set.name }}</u></h3></a>
                        </div>
                        <div class="panel-body">
                            <div class="input-group">
                                <select id="filter_images" class="form-control">
                                    <option value="All" name="All"
                                            class="bold">{% trans 'Show All' %}</option>
                                    <option value="Unverified" name="Unverified"
                                            class="bold">{% trans 'Show Unverified' %}</option>
                                    <option value="Verified" name="Verified"
                                            class="bold">{% trans 'Show Verified' %}</option>
                                    <option value="NoAnnotations" name="NoAnnotations"
                                            class="bold">{% trans 'No Annotations' %}</option>
                                    <option value="ComputerGenerated" name="ComputerGenerated"
                                            class="bold">{% trans 'Computer Generated' %}</option>

                                    {% for annotation_type in annotation_types %}

                                        <option value="{{ annotation_type.id }}" name="{{ annotation_type.name }}">
                                            {{ annotation_type.name }} ({{annotation_type.product.name}}) </option>

                                    {% endfor %}

                                    {% for annotation_type in global_annotation_types %}

                                        <option value="{{ annotation_type.id }}" name="{{ annotation_type.name }}">
                                            {{ annotation_type.name }} ({{annotation_type.product.name}}) </option>

                                    {% endfor %}

                                </select>
                                <span class="input-group-btn">
                                      <button class="btn btn-primary" id="filter_update_btn"><span
                                              class="glyphicon glyphicon-refresh"></span></button>
                                    </span>
                            </div>
                            <br>
                            <div id="image_list">
                                <ul class="nav nav-tabs"  role="tablist">
                                    <li class="active">
                                        <a data-toggle="tab" href="#imageList">Image List</a>
                                    </li>
                                    <li>
                                        <a data-toggle="tab" href="#imageGrid" id="imageGridButton">Image Grid</a>
                                    </li>
                                </ul>
                                <div class="tab-content">
                                    <div id="imageList" class="tab-pane fade in active">
                                        {% for set_image in set_images %}
                                            <a id="annotate_image_link_{{ set_image.id }}"
                                                href="{% url 'annotations:annotate' set_image.id %}{% if filtered is not None %}?selected_annotation_type={{ filtered }}{% endif %}"
                                                class="annotate_image_link {% if set_image.id == selected_image.id %}active{% endif %}"
                                                data-image_id="{{ set_image.id }}">
                                                {{ set_image.name }}
                                            </a>                                    
                                        {% endfor %}
                                    </div>
                                    <div id="imageGrid" class="tab-pane fade">
                                        {% for set_image in set_images %}
                                            <a href="{% url 'annotations:annotate' set_image.id %}">
                                                <img id="imageThumbnail_{{ set_image.id }}" alt="Loading thumbnail"                                             
                                                    data-image_id="{{ set_image.id }}">
                                            </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <br>
                            <div>
                                <div class="col-md-3">
                                    <button type="button" class="annotate_button btn btn-default btn-block"
                                            id="back_button">
                                        <span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span> Back
                                        (s)
                                    </button>
                                </div>

                                {% if 'delete_images' in imageset_perms and not imageset_lock %}
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-danger" id="delete-button"
                                                data-toggle="modal" data-target="#deleteModal" style="width: 100%">
                                                <span class="glyphicon glyphicon-trash" aria-hidden="true"
                                                    style="padding-right: 3px;"></span>
                                        </button>
                                    </div>
                                {% endif %}

                                {% if 'annotate' in imageset_perms %}
                                    <div class="col-sm-3">
                                        <button type="button" class="annotate_button btn btn-default btn-block"
                                                id="verify_image_button">
                                            <span class="glyphicon glyphicon-floppy-save" aria-hidden="true"></span> Verify (f)
                                        </button>
                                    </div>
                                {% endif %}


                                <div class="col-md-3">
                                    <button type="button" class="annotate_button btn btn-default btn-block"
                                            id="skip_button">
                                        <span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span> Skip
                                        (d)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 id="active_image_name" class="panel-title">{{ selected_image.name }}</h3>
                        </div>
                        <div class="panel-body">
                                {% csrf_token %}
                                <input type="hidden" name="image_id" value="{{ selected_image.id }}">

                                <ul class="nav nav-tabs" id="statistics_tabs" role="tablist" style="overflow-x: auto;
                                                                    display: -webkit-box; overflow-y: hidden">
                                    
                                    {% if annotation_types %}
                                    <li class="nav-item" style="float: none">
                                        <a class="nav-link active" id="default_statistics_tab" data-toggle="tab"
                                           href="#home" role="tab" aria-controls="home">Statistics</a>
                                    </li>
                                    {% endif %}

                                    {% if global_annotation_types %}
                                    <li class="nav-item" style="float: none">
                                        <a class="nav-link active" id="default_global_annotation_tab" data-toggle="tab"
                                           href="#nav-item_global" role="tab" aria-controls="home">Image</a>
                                    </li>

                                    {% endif %}

                                    <li class="nav-item" style="float: none">
                                        <a class="nav-link active" id="default_annotation_tab" data-toggle="tab"
                                           href="#nav-item_anno" role="tab" aria-controls="home">Annotation</a>
                                    </li>

                                    {% if HasMediaFiles %}

                                    <li class="nav-item" style="float: none">
                                        <a class="nav-link active" id="default_media_tab" data-toggle="tab"
                                           href="#nav-item_media" role="tab" aria-controls="home">Media</a>
                                    </li>

                                    {% endif %}

                                    <li class="nav-item" style="float: none">
                                        <a class="nav-link active" id="default_search_tab" data-toggle="tab"
                                           href="#nav-item_search" role="tab" aria-controls="home">Search</a>
                                    </li>

                                    <li class="nav-item" style="float: none">
                                        <a class="nav-link active" id="default_filter_openseadragon_tab" data-toggle="tab"
                                           href="#nav-item_openseadragon_filter" role="tab" aria-controls="home">Filter</a>
                                    </li>

                                    <li class="nav-item" style="float: none">
                                        <a class="nav-link active" id="default_screening_tool" data-toggle="tab"
                                           href="#nav-item_screening_tool" role="tab" aria-controls="home">Screening</a>
                                    </li>
                                    
                                </ul>

                                <div class="tab-content" id="statistics_tabs_content" 
                                    style="overflow-y: scroll; max-height: 250px;">
                                    
                                    {% if annotation_types %}
                                    <div class="tab-pane fade in active" id="home">
                                        <table style="width: 100%; text-align: center" class="table table-striped table-bordered table-sm">
                                            <tr>
                                                <th>Label</th>
                                                <th>Key</th>
                                                <th>
                                                    <label data-toggle="tooltip" data-placement="right"
                                                           title="( Number of annotations / Number of validated annotations )">
                                                        Count

                                                    </label>
                                                </th>
                                                <th>Color</th>
                                                <th>Example</th>
                                            </tr>

                                            {% for annotation_type in annotation_types %}
                                                <tr>
                                                    <td id="annotation_type_id_button_{{ annotation_type.id }}" 
                                                        data-annotation_type_id={{ annotation_type.id }}>
                                                        {{ annotation_type.name }}
                                                    </td>
                                                    <td>{{ forloop.counter0 }}</td>
                                                    <td id="{{ annotation_type.name }}_{{ annotation_type.id }}">{{ annotation_type.node_count }}</td>
                                                    <td style="background-color: {{ annotation_type.color_code }}">
                                                        <input type="checkbox" id="DrawCheckBox_{{ annotation_type.id }}"
                                                               data-annotation_type_id={{ annotation_type.id }} checked>
                                                    </td>
                                                    <td>
                                                        <a href="{{ annotation_type.image_file}}">
                                                            <img src="{{ annotation_type.image_file}}" style="widows: 50px; height: 50px" >
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </table>
                                    </div>
                                    {% endif %}

                                    {% if global_annotation_types %}

                                    <div class="tab-pane fade in" id="nav-item_global">
                                        <table style="width: 100%; text-align: center" class="table table-striped table-bordered table-sm">
                                            <tr>
                                                <th class="text-center">Label</th>
                                                <th></th>
                                            </tr>

                                            {% for annotation_type in global_annotation_types %}

                                            <tr>

                                                <td>{{ annotation_type.name }}</td>
                                                <td>
                                                    <input type="checkbox" id="GlobalAnnotation_{{ annotation_type.id }}"
                                                           data-annotation_type_id={{ annotation_type.id }}>
                                                </td>
                                            </tr>


                                            {% endfor %}
                                        
                                        
                                        </table>
                                    </div>

                                    {% endif %}

                                    <div class="tab-pane fade in" id="nav-item_anno">

                                        <div id="AnnotationInformation">
                                            <table style="width: 100%; margin-top: 10px; text-align: center">
                                                <tr>
                                                    <th></th>
                                                    <th></th>
                                                    <th>Remark</th>
                                                </tr>

                                                <tr>
                                                    <td>First Editor:</td>
                                                    <td>
                                                        <a id="annotationFirstEditor"></a>
                                                    </td>
                                                    <td rowspan="5">
                                                        <textarea id="annotationRemark" rows="5" cols="10"
                                                                  style="resize: none;">
                                                        </textarea>
                                                    </td>
                                                </tr>

                                                <tr>
                                                    <td>Last Editor:</td>
                                                    <td>
                                                        <a id="annotationLastEditor"></a>
                                                    </td>
                                                </tr>

                                                <tr>
                                                    <td>Unique ID:</td>
                                                    <td>
                                                        <a id="annotationUniqueID"></a>
                                                    </td>
                                                </tr>

                                                <tr>
                                                    <td>Verified:</td>
                                                    <td>
                                                        <label id="annotationVerified"></label>
                                                    </td>
                                                </tr>
                                            </table>

                                        </div>

                                    </div>

                                    {% if HasMediaFiles %}

                                    <div class="tab-pane fade in" id="nav-item_media">

                                        <div id="AnnotationMediaInformation">

                                            <table style="width: 100%; margin-top: 10px; text-align: center">
                                            
                                                <tr id="show_audio">                                                    
                                                    <td>
                                                        <audio id="audio" controls="controls">
                                                            <source id="annotationAudio" src="" type="audio/mpeg">
                                                                Your browser does not support the audio format.
                                                        </audio>  
                                                    </td>
                                                    <td>
                                                        <input type='checkbox' id='autoplay_media' name="autoplay_media" checked>
                                                        <label for='autoplay_media'>AutoPlay</label>

                                                    </td>
                                                </tr>
                                            
                                            
                                            </table>

                                        </div>

                                    </div>

                                    {% endif %}

                                    <div class="tab-pane fade in" id="nav-item_search">

                                        <div class="input-group">
                                            <input type="text" id="searchInputAnnotation" placeholder="Search for annotations.."
                                                title="Search Syntax: @Field:Value; [@Field:Value]" class="form-control">
                                            <span class="input-group-btn">
                                                <button class="btn btn-primary" id="search_update_btn">
                                                    <span class="glyphicon glyphicon-search"/>
                                                </button>
                                            </span>
                                        </div>

                                        <table style="width: 100%; margin-top: 10px; text-align: center"
                                            class="table table-striped table-bordered table-sm">
                                            <tbody id="annotationSearchResults">
                                                <tr>
                                                    <th>ID:</th>
                                                    <th>Label:</th>
                                                    <th>First Editor:</th>
                                                    <th>Last Editor:</th>
                                                    <th>Verified:</th>
                                                    <th>Remark:</th>
                                                </tr>
                                            </tbody>

                                        </table>
                                    </div>


                                    <div class="tab-pane fade in" id="nav-item_openseadragon_filter">

                                        <div class="row-md-sm">
                                            <label for="BRIGHTNESSSlider">Brigthness</label>

                                            <input id="BRIGHTNESSSlider" type="text"  data-slider-min="-255" data-slider-max="255" 
                                                    data-slider-step="1" data-slider-value="0" data-slider-enabled="false"/>

                                            <input id="BRIGHTNESSSlider-enabled" type="checkbox"/> 

                                        </div>
                                        <div class="row-md-sm">
                                            <label for="ContrastSlider">Contrast</label>
                                            <input id="ContrastSlider" type="text"  data-slider-min="0" data-slider-max="10"
                                                data-slider-step="0.1" data-slider-value="1" data-slider-enabled="false"/>
                                            <input id="ContrastSlider-enabled" type="checkbox"/>
                                        </div>

                                        <div class="row-md-sm">
                                            <label for="CLAHESlider">CLAHE</label>
                                            <input id="CLAHESlider" type="text"  data-slider-min="0" data-slider-max="50" 
                                                data-slider-step="1" data-slider-value="1" data-slider-enabled="false"/>
                                            <input id="CLAHESlider-enabled" type="checkbox"/>
                                        </div>

                                        <div class="row-md-sm">
                                            <label for="THRESHOLDINGSlider">Thresholding</label>
                                            <input id="THRESHOLDINGSlider" type="text"  data-slider-min="0" data-slider-max="255" 
                                                data-slider-step="1" data-slider-value="128" data-slider-enabled="false"/>
                                            <input id="THRESHOLDINGSlider-enabled" type="checkbox"/> 
                                        </div>

                                        <div class="row-md">
                                            <div class="col-md-3">
                                                <input id="Invert-enabled" type="checkbox"/> Invert
                                            </div>
                                            <div class="col-md-2">
                                                <input id="GREYSCALE-enabled" type="checkbox"/> Grey
                                            </div>
                                            <div class="col-md-2">
                                                <input id="Red-enabled" type="checkbox" checked=true/> R
                                            </div>
                                            <div class="col-md-2">
                                                <input id="Green-enabled" type="checkbox" checked =true/> G
                                            </div>
                                            <div class="col-md-2">
                                                <input id="Blue-enabled" type="checkbox" checked=true/> B
                                            </div>
                                        </div>

                                    </div>

                                    <div class="tab-pane fade in" id="nav-item_screening_tool">

                                        <div class="input-group">
                                            <input type="number" id="screeningResolutionX" placeholder="350"
                                                    title="Screening tile size in pixel X" class="form-control" style="width: 50%;" value={{ resolution_x }}>
                                            <input type="number" id="screeningResolutionY" placeholder="350"
                                                    title="Screening tile size in pixel Y" class="form-control" style="width: 50%;" value={{ resolution_y }}>
                                            <span class="input-group-btn">
                                                <button class="btn btn-primary" id="screening_resolution_update_btn">
                                                    <span class="glyphicon glyphicon-play">
                                                </button>
                                            </span>
                                        </div>

                                        <div>
                                            <img id="screeningImage" alt="Screening mode not initialised!" class="hidden"></br>
                                            <canvas id="screeningImageOutput"  alt="Screening mode not initialised!"
                                                style="width: -webkit-fill-available; height: -webkit-fill-available"></canvas>
                                        </div>
                                    </div>

                                </div>

                                <div class="row">
                                    <div class="col-md-2">
                                        
                                        <input id="StrokeWidthSlider" type="range"  class="custom-range" min="1"
                                               max="500" step="1" value="5"/>
                                        <label for="StrokeWidthSlider">Stroke</label>
                                    </div>
                                    
                                    <div class="col-md-2">
                                        <label for='statistics_total_annotations' title="Total Annotations">Total:</label>
                                        <label id="statistics_total_annotations" title="Total Annotations">{{ total_annotations }}</label>
                                    </div>

                                    <div class="col-md-8">
                                        <select id="annotation_type_id" name="selected_annotation_type" class="form-control">
                                            {% for annotation_type in annotation_types %}

                                                <option value="{{ annotation_type.id }}" name="{{ annotation_type.name }}" 
                                                            id="annotation_type_{{ annotation_type.id }}" data-annotation_type_key={{ forloop.counter0 }}>
                                                    {{ annotation_type.name }} ({{forloop.counter0}}) 
                                                </option>

                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div style="width: 100%" id="zoomSlider"></div>
                <div class="col-md" id="openseadragon1" style="width: 85vh; height: 600px;"></div>
            </div>

        </div>
    </div>

    <span id="image_id" class="hidden">{{ selected_image.id }}</span>
    <span id="image_set_id" class="hidden">{{ selected_image.image_set.id }}</span>
    <span id="user_id" class="hidden">{{ user_id }}</span>
    {% if 'delete_images' in imageset_perms and not imageset_lock %}
        <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">
                            Delete the image
                        </h4>
                    </div>
                    <div class="modal-body">
                        Do you really want to permanently delete this image from the imageset?
                    </div>
                    <div class="modal-footer">
                        <form method="post" action="{% url 'images:delete_images' selected_image.id %}">
                            {% csrf_token %}
                            <input id="next-image-id" type="hidden" name="next-image-id"
                                   value="{{ set_images.first.id }}">
                            <div class="input-group" role="group" aria-label="delete-image">
                                <button type="submit" class="btn btn-danger">Yes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}



